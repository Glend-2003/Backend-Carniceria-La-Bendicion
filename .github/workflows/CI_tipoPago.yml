name: CI/CD Pipeline - CarnicerÃ­a La BendiciÃ³n

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: bdcarniceria
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Wait for MySQL
      run: |
        until docker exec ${{ job.services.mysql.id }} mysqladmin ping --silent; do
          echo 'Waiting for MySQL...'
          sleep 2
        done
    
    - name: Run Unit Tests
      run: |
        echo "ğŸ§ª Ejecutando pruebas unitarias..."
        mvn test -Dtest=TipoPagoServiceTest
        
    - name: Run Integration Tests
      run: |
        echo "ğŸ”— Ejecutando pruebas de integraciÃ³n..."
        mvn test -Dtest=TipoPagoControllerTest
        
    - name: Generate Test Report
      run: |
        echo "ğŸ“Š Generando reporte de pruebas..."
        mvn surefire-report:report
        
    - name: Build Application
      run: |
        echo "ğŸ—ï¸ Construyendo aplicaciÃ³n..."
        mvn clean package -DskipTests
        
    - name: Send Email Notification on Success
      if: success()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: âœ… Pipeline Exitoso - CarnicerÃ­a La BendiciÃ³n
        body: |
          Â¡Excelente trabajo! ğŸ‰
          
          Las pruebas automatizadas han pasado exitosamente:
          - âœ… Pruebas unitarias del servicio TipoPago
          - âœ… Pruebas de integraciÃ³n del controlador
          - âœ… ConstrucciÃ³n de la aplicaciÃ³n
          
          Commit: ${{ github.sha }}
          Rama: ${{ github.ref }}
          
          El cÃ³digo estÃ¡ listo para fusionar a MAIN.
        to: degutierrezh02@gmail.com
        from: CarnicerÃ­a CI/CD
        
    - name: Send Email Notification on Failure
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: âŒ Pipeline Fallido - CarnicerÃ­a La BendiciÃ³n
        body: |
          Â¡AtenciÃ³n! âŒ
          
          El pipeline ha fallado. Revisa los siguientes puntos:
          - Errores en las pruebas unitarias
          - Problemas en las pruebas de integraciÃ³n
          - Fallos en la construcciÃ³n
          
          Commit: ${{ github.sha }}
          Rama: ${{ github.ref }}
          
          Por favor, revisa los logs para mÃ¡s detalles.
        to: degutierrezh02@gmail.com
        from: CarnicerÃ­a CI/CD

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Merge to Main
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        git fetch origin main
        git checkout main
        git merge origin/dev-qa --no-edit
        git push origin main
        
    - name: Deploy to Production
      run: |
        echo "ğŸš€ Desplegando a producciÃ³n..."
        # AquÃ­ agregarÃ­as los comandos especÃ­ficos de despliegue
        # Por ejemplo: scp, rsync, o comandos FTP
        echo "AplicaciÃ³n desplegada exitosamente"
        
    - name: Send Deployment Notification
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: ğŸš€ Despliegue Exitoso - CarnicerÃ­a La BendiciÃ³n
        body: |
          Â¡Despliegue completado! ğŸš€
          
          La aplicaciÃ³n ha sido desplegada exitosamente a producciÃ³n:
          - âœ… FusiÃ³n automÃ¡tica DEV-QA â†’ MAIN
          - âœ… Despliegue a servidor de producciÃ³n
          
          Commit: ${{ github.sha }}
          
          La nueva versiÃ³n estÃ¡ disponible.
        to: degutierrezh02@gmail.com
        from: CarnicerÃ­a CI/CD