name: Deploy to Production

# Se ejecuta solo cuando hay cambios en main despu√©s del merge autom√°tico
on:
  push:
    branches: [ main ]
  workflow_run:
    workflows: ["TipoPago CI/CD Pipeline"]
    types: [completed]
    branches: [ main ]

jobs:
  deploy:
    name: Desplegar a Producci√≥n
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        
      - name: Descargar artefacto JAR
        uses: actions/download-artifact@v3
        with:
          name: carniceria-app
          path: ./deploy
          
      - name: Desplegar v√≠a FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./deploy/
          server-dir: /public_html/carniceria/
          
      - name: Notificar despliegue exitoso
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "üöÄ Despliegue Exitoso - TipoPago en Producci√≥n"
          body: |
            üéâ ¬°Despliegue completado exitosamente!
            
            üì¶ La aplicaci√≥n con las funcionalidades de TipoPago ha sido desplegada a producci√≥n.
            
            üîó Detalles:
            - Fecha: $(date)
            - Commit: ${{ github.sha }}
            - Servidor: ${{ secrets.FTP_SERVER }}
            
            ‚úÖ El m√≥dulo TipoPago est√° disponible en producci√≥n con las siguientes funcionalidades:
            - Agregar tipo de pago
            - Validaciones implementadas
            - Pruebas unitarias verificadas
            
            üîç Monitorea la aplicaci√≥n para asegurar que todo funcione correctamente.
          to: tu-email@example.com
          from: deploy-carniceria@example.com
