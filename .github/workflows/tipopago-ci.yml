name: TipoPago CI/CD Pipeline (Sin Secrets)

# ConfiguraciÃ³n de triggers - cuÃ¡ndo se ejecuta el pipeline
on:
  push:
    branches: [ DEV-QA, main ]
    paths:
      - 'src/main/java/com/bendicion/la/carniceria/carniceria/controller/TipoPagoController.java'
      - 'src/main/java/com/bendicion/la/carniceria/carniceria/service/TipoPagoService.java'
      - 'src/main/java/com/bendicion/la/carniceria/carniceria/domain/TipoPago.java'
      - 'src/test/java/com/bendicion/la/carniceria/carniceria/test/TipoPago*Test.java'
  pull_request:
    branches: [ DEV-QA, main ]
    paths:
      - 'src/main/java/com/bendicion/la/carniceria/carniceria/controller/TipoPagoController.java'
      - 'src/main/java/com/bendicion/la/carniceria/carniceria/service/TipoPagoService.java'
      - 'src/test/java/com/bendicion/la/carniceria/carniceria/test/TipoPago*Test.java'

env:
  JAVA_VERSION: '17'
  MAVEN_VERSION: '3.9.5'

jobs:
  # Job 1: Ejecutar pruebas unitarias
  test:
    name: Ejecutar Pruebas TipoPago
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: Configurar Java JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          
      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
          
      - name: Verificar existencia de pruebas TipoPago
        run: |
          echo "ğŸ” Verificando pruebas de TipoPago..."
          if [ -f "src/test/java/com/bendicion/la/carniceria/carniceria/test/TipoPagoControllerTest.java" ] && 
             [ -f "src/test/java/com/bendicion/la/carniceria/carniceria/test/TipoPagoServiceTest.java" ]; then
            echo "âœ… Pruebas de TipoPago encontradas"
            echo "ğŸ“‹ TipoPagoControllerTest.java âœ“"
            echo "ğŸ“‹ TipoPagoServiceTest.java âœ“"
            echo "TESTS_EXIST=true" >> $GITHUB_ENV
          else
            echo "âŒ No se encontraron las pruebas de TipoPago"
            echo "âŒ Archivos requeridos:"
            echo "   - TipoPagoControllerTest.java"
            echo "   - TipoPagoServiceTest.java"
            exit 1
          fi
          
      - name: Compilar el proyecto
        run: |
          echo "ğŸ”¨ Compilando proyecto..."
          mvn clean compile -DskipTests
          echo "âœ… CompilaciÃ³n exitosa"
        
      - name: Ejecutar pruebas TipoPago
        if: env.TESTS_EXIST == 'true'
        run: |
          echo "ğŸ§ª Ejecutando pruebas especÃ­ficas de TipoPago..."
          echo "ğŸ“ Pruebas a ejecutar:"
          echo "   - TipoPagoControllerTest"
          echo "   - TipoPagoServiceTest"
          
          mvn test -Dtest="TipoPagoControllerTest,TipoPagoServiceTest" -Dmaven.test.failure.ignore=false
          
          # Verificar si las pruebas pasaron
          if [ $? -eq 0 ]; then
            echo "âœ… Todas las pruebas de TipoPago pasaron exitosamente"
            echo "TEST_RESULT=success" >> $GITHUB_ENV
          else
            echo "âŒ Algunas pruebas de TipoPago fallaron"
            echo "TEST_RESULT=failure" >> $GITHUB_ENV
            exit 1
          fi
          
      - name: Generar reporte de cobertura
        if: env.TESTS_EXIST == 'true' && env.TEST_RESULT == 'success'
        run: |
          echo "ğŸ“Š Generando reporte de cobertura..."
          mvn jacoco:report
          echo "âœ… Reporte generado exitosamente"
        
      - name: Mostrar resumen de pruebas
        if: always()
        run: |
          echo "ğŸ“‹ ===== RESUMEN DE PRUEBAS TIPOPAGO ====="
          echo "ğŸ” Archivos verificados:"
          echo "   - TipoPagoControllerTest.java"
          echo "   - TipoPagoServiceTest.java"
          echo ""
          echo "ğŸ§ª Pruebas ejecutadas:"
          echo "   - testAgregarTipoPago_Exitoso"
          echo "   - testAgregarTipoPago_DatosIncompletos"  
          echo "   - testAgregarTipoPago_ErrorInterno"
          echo "   - testAgregarTipoPago_DescripcionVacia"
          echo "   - testAgregarTipoPago_DescripcionNula"
          echo ""
          if [ "${{ env.TEST_RESULT }}" = "success" ]; then
            echo "âœ… RESULTADO: TODAS LAS PRUEBAS PASARON"
            echo "ğŸ‰ El mÃ³dulo TipoPago estÃ¡ funcionando correctamente"
          else
            echo "âŒ RESULTADO: ALGUNAS PRUEBAS FALLARON"
            echo "ğŸ”§ Revisar errores antes de continuar"
          fi
          echo "=================================="
        
      - name: Subir reportes de pruebas
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-reports-tipopago-${{ github.run_number }}
          path: |
            target/surefire-reports/
            target/site/jacoco/
            
      - name: Comentar resultados en PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const testResult = process.env.TEST_RESULT;
            let comment = '## ğŸ§ª Resultados de Pruebas TipoPago\n\n';
            
            if (testResult === 'success') {
              comment += '### âœ… PRUEBAS EXITOSAS\n\n';
              comment += 'ğŸ‰ Todas las pruebas de TipoPago pasaron correctamente:\n\n';
              comment += '#### Pruebas Controller:\n';
              comment += '- âœ… `testAgregarTipoPago_Exitoso`\n';
              comment += '- âœ… `testAgregarTipoPago_DatosIncompletos`\n';
              comment += '- âœ… `testAgregarTipoPago_ErrorInterno`\n\n';
              comment += '#### Pruebas Service:\n';
              comment += '- âœ… `testAgregarTipoPago_Exitoso`\n';
              comment += '- âœ… `testAgregarTipoPago_DescripcionVacia`\n';
              comment += '- âœ… `testAgregarTipoPago_DescripcionNula`\n\n';
              comment += 'ğŸ“Š **Reporte de cobertura disponible en los artefactos**\n\n';
              comment += 'ğŸš€ **El cÃ³digo estÃ¡ listo para merge**';
            } else {
              comment += '### âŒ PRUEBAS FALLIDAS\n\n';
              comment += 'âš ï¸ Algunas pruebas de TipoPago no pasaron.\n\n';
              comment += 'ğŸ” **Acciones requeridas:**\n';
              comment += '1. Revisar los logs de las pruebas fallidas\n';
              comment += '2. Corregir los errores encontrados\n';
              comment += '3. Volver a ejecutar las pruebas\n\n';
              comment += 'ğŸ“‹ **Archivos a revisar:**\n';
              comment += '- `TipoPagoController.java`\n';
              comment += '- `TipoPagoService.java`\n';
              comment += '- Tests correspondientes\n\n';
              comment += 'â›” **No hacer merge hasta que todas las pruebas pasen**';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Job 2: Build (solo si las pruebas pasan)
  build:
    name: Build y Package
    runs-on: ubuntu-latest
    needs: test
    if: success()
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: Configurar Java JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          
      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
          
      - name: Construir JAR
        run: |
          echo "ğŸ“¦ Construyendo JAR de la aplicaciÃ³n..."
          mvn clean package -DskipTests
          echo "âœ… JAR construido exitosamente"
          
      - name: Verificar JAR generado
        run: |
          echo "ğŸ” Verificando JAR generado..."
          ls -la target/*.jar
          echo "âœ… JAR verificado"
        
      - name: Subir JAR como artefacto
        uses: actions/upload-artifact@v3
        with:
          name: carniceria-app-tipopago-${{ github.run_number }}
          path: target/*.jar
          
      - name: Resumen del build
        run: |
          echo "ğŸ“‹ ===== RESUMEN DEL BUILD ====="
          echo "âœ… CompilaciÃ³n exitosa"
          echo "âœ… JAR generado correctamente"
          echo "âœ… Artefacto subido para despliegue"
          echo "ğŸ¯ MÃ³dulo TipoPago listo para producciÃ³n"
          echo "============================"

  # Job 3: NotificaciÃ³n de resultado (sin email real)
  notification:
    name: Resumen Final
    runs-on: ubuntu-latest
    needs: [test, build]
    if: always()
    
    steps:
      - name: Resumen final del pipeline
        run: |
          echo "ğŸ¯ ===== RESUMEN FINAL CI/CD TIPOPAGO ====="
          echo "ğŸ“… Fecha: $(date)"
          echo "ğŸ”— Repositorio: ${{ github.repository }}"
          echo "ğŸŒ¿ Rama: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Actor: ${{ github.actor }}"
          echo "ğŸ”§ Commit: ${{ github.sha }}"
          echo ""
          
          if [ "${{ needs.test.result }}" = "success" ] && [ "${{ needs.build.result }}" = "success" ]; then
            echo "âœ… PIPELINE EXITOSO"
            echo "ğŸ‰ Todas las pruebas de TipoPago pasaron"
            echo "ğŸ“¦ Build completado correctamente"
            echo "ğŸš€ AplicaciÃ³n lista para despliegue"
            echo ""
            echo "ğŸ“‹ Funcionalidades verificadas:"
            echo "   - Agregar tipo de pago"
            echo "   - ValidaciÃ³n de datos"
            echo "   - Manejo de errores"
            echo "   - LÃ³gica de negocio"
          else
            echo "âŒ PIPELINE FALLIDO"
            echo "âš ï¸ Revisa los errores en los jobs anteriores"
            echo "ğŸ”§ Corrige los problemas antes del prÃ³ximo push"
          fi
          echo "========================================="